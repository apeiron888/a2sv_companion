<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2SV Companion Admin</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .tab-active {
            border-bottom: 2px solid #111827;
            color: #111827;
        }
        .card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
        }
        .btn-primary {
            background: #111827;
            color: #fff;
        }
        .btn-primary:hover { background: #0f172a; }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: #10b981; color: #fff; }
        .btn-success:hover { background: #059669; }
        .btn-soft { background: #f3f4f6; color: #111827; }
        .btn-soft:hover { background: #e5e7eb; }
        .input {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px 12px;
            outline: none;
        }
        .input:focus {
            border-color: #111827;
            box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.1);
        }
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="max-w-5xl mx-auto py-10 px-4">
        <div class="flex items-center gap-3 mb-6">
            <div class="h-12 w-12 rounded-2xl bg-gray-900 text-white flex items-center justify-center font-bold">A2SV</div>
            <div>
                <h1 class="text-3xl font-bold text-gray-900">A2SV Companion Admin</h1>
                <p class="text-sm text-gray-500">Manage group sheets and refresh mappings.</p>
            </div>
        </div>

        <!-- API Key Section -->
        <div class="card p-6 mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="password" id="apiKey" placeholder="Enter your admin API key" class="flex-1 input">
                <button onclick="saveApiKey()" class="btn-primary px-4 py-2 rounded flex items-center gap-2 justify-center">
                    <i class="fas fa-save"></i> Save Key
                </button>
            </div>
            <p id="keyStatus" class="text-sm mt-2 text-green-600 hidden">Key saved!</p>
        </div>

        <!-- Tabs -->
        <div class="border-b border-gray-200 mb-4">
            <nav class="flex -mb-px">
                <button onclick="showTab('add')" id="tabAdd" class="tab-button mr-8 py-2 px-1 border-b-2 font-medium text-sm transition-colors" data-tab="add">
                    <i class="fas fa-plus mr-1"></i> Add Sheet
                </button>
                <button onclick="showTab('remove')" id="tabRemove" class="tab-button mr-8 py-2 px-1 border-b-2 font-medium text-sm transition-colors" data-tab="remove">
                    <i class="fas fa-trash mr-1"></i> Remove Sheet
                </button>
                <button onclick="showTab('list')" id="tabList" class="tab-button py-2 px-1 border-b-2 font-medium text-sm transition-colors" data-tab="list">
                    <i class="fas fa-list mr-1"></i> List Sheets
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div id="addTab" class="tab-content card p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-900">Add New Group Sheet</h2>
            <form id="addForm" onsubmit="addSheet(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sheet ID <span class="text-red-500">*</span></label>
                    <input type="text" id="sheetId" required class="w-full input">
                    <p class="text-xs text-gray-500 mt-1">The Google Sheet ID (from the URL)</p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name (optional)</label>
                    <input type="text" id="sheetName" class="w-full input">
                </div>
                <button type="submit" class="btn-success px-4 py-2 rounded flex items-center gap-2">
                    <i class="fas fa-plus-circle"></i> Add Sheet
                </button>
            </form>
            <div id="addMessage" class="mt-4"></div>
        </div>

        <div id="removeTab" class="tab-content card p-6 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-900">Remove Group Sheet</h2>
            <form id="removeForm" onsubmit="removeSheet(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sheet ID <span class="text-red-500">*</span></label>
                    <input type="text" id="removeSheetId" required class="w-full input">
                </div>
                <button type="submit" class="btn-danger px-4 py-2 rounded flex items-center gap-2">
                    <i class="fas fa-trash-alt"></i> Remove Sheet
                </button>
            </form>
            <div id="removeMessage" class="mt-4"></div>
        </div>

        <div id="listTab" class="tab-content card p-6 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-900">Tracked Group Sheets</h2>
            <div class="flex flex-wrap gap-2 mb-4">
                <button onclick="listSheets()" class="btn-soft px-4 py-2 rounded flex items-center gap-2">
                    <i class="fas fa-sync-alt"></i> Refresh List
                </button>
                <button onclick="refreshMapping()" class="btn-success px-4 py-2 rounded flex items-center gap-2">
                    <i class="fas fa-bolt"></i> Refresh Mapping Now
                </button>
            </div>
            <div id="mappingStatus" class="text-sm text-gray-600 mb-2"></div>
            <div id="listContainer" class="max-h-96 overflow-y-auto border border-gray-200 rounded-xl">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sheet ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created At</th>
                        </tr>
                    </thead>
                    <tbody id="sheetList" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No data</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Store API key in sessionStorage
        function saveApiKey() {
            const key = document.getElementById('apiKey').value;
            if (key) {
                sessionStorage.setItem('adminApiKey', key);
                document.getElementById('keyStatus').classList.remove('hidden');
                setTimeout(() => document.getElementById('keyStatus').classList.add('hidden'), 3000);
            }
        }

        function getApiKey() {
            return sessionStorage.getItem('adminApiKey') || '';
        }

        // Tab switching
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            // Show selected
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            // Update tab button styles
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('tab-active', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            const activeBtn = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            activeBtn.classList.add('tab-active', 'border-blue-500', 'text-blue-600');
        }

        // Add sheet
        async function addSheet(event) {
            event.preventDefault();
            const apiKey = getApiKey();
            if (!apiKey) {
                alert('Please save your API key first.');
                return;
            }
            const sheetId = document.getElementById('sheetId').value;
            const name = document.getElementById('sheetName').value;
            const messageDiv = document.getElementById('addMessage');
            messageDiv.innerHTML = '';

            try {
                const response = await fetch('/admin/sheets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey
                    },
                    body: JSON.stringify({ sheetId, name })
                });
                const data = await response.json();
                if (response.ok) {
                    messageDiv.innerHTML = '<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">Sheet added successfully!</div>';
                    document.getElementById('addForm').reset();
                } else {
                    messageDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">Error: ${data.error || 'Unknown error'}</div>`;
                }
            } catch (err) {
                messageDiv.innerHTML = '<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">Network error</div>';
            }
        }

        // Remove sheet
        async function removeSheet(event) {
            event.preventDefault();
            const apiKey = getApiKey();
            if (!apiKey) {
                alert('Please save your API key first.');
                return;
            }
            const sheetId = document.getElementById('removeSheetId').value;
            const messageDiv = document.getElementById('removeMessage');
            messageDiv.innerHTML = '';

            try {
                const response = await fetch(`/admin/sheets/${sheetId}`, {
                    method: 'DELETE',
                    headers: { 'x-api-key': apiKey }
                });
                const data = await response.json();
                if (response.ok) {
                    messageDiv.innerHTML = '<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">Sheet removed successfully!</div>';
                    document.getElementById('removeForm').reset();
                } else {
                    messageDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">Error: ${data.error || 'Unknown error'}</div>`;
                }
            } catch (err) {
                messageDiv.innerHTML = '<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">Network error</div>';
            }
        }

        // List sheets
        async function listSheets() {
            const apiKey = getApiKey();
            if (!apiKey) {
                alert('Please save your API key first.');
                return;
            }
            const tbody = document.getElementById('sheetList');
            tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';

            try {
                const response = await fetch('/admin/sheets', {
                    headers: { 'x-api-key': apiKey }
                });
                const data = await response.json();
                if (response.ok) {
                    const sheets = data.sheets || [];
                    if (sheets.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No sheets tracked</td></tr>';
                    } else {
                        tbody.innerHTML = sheets.map(s => `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-mono">${s.sheetId}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${s.name || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${new Date(s.createdAt).toLocaleString()}</td>
                            </tr>
                        `).join('');
                    }
                } else {
                    tbody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-red-500">Error: ${data.error || 'Unknown'}</td></tr>`;
                }
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-red-500">Network error</td></tr>';
            }
        }

        // Refresh mapping
        async function refreshMapping() {
            const apiKey = getApiKey();
            if (!apiKey) {
                alert('Please save your API key first.');
                return;
            }
            const status = document.getElementById('mappingStatus');
            status.textContent = 'Refreshing mapping...';

            try {
                const response = await fetch('/admin/refresh-mapping', {
                    method: 'POST',
                    headers: { 'x-api-key': apiKey }
                });
                const data = await response.json();
                if (response.ok) {
                    status.textContent = 'Mapping refresh completed.';
                } else {
                    status.textContent = `Error: ${data.error || 'Unknown'}`;
                }
            } catch (err) {
                status.textContent = 'Network error while refreshing mapping.';
            }
        }

        // Auto-load list if tab is active on page load (if hash is #list)
        window.onload = function() {
            // Check if API key already exists in sessionStorage (from previous visit)
            const savedKey = sessionStorage.getItem('adminApiKey');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }
            // Show tab based on hash
            const hash = window.location.hash.substring(1) || 'add';
            showTab(hash);
        };
    </script>
</body>
</html>